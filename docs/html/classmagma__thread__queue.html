<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>MAGMA: magma_thread_queue Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>magma_thread_queue Class Reference</h1><!-- doxytag: class="magma_thread_queue" -->
<p>Implements a thread pool with a multi-producer, multi-consumer queue.  
<a href="#_details">More...</a></p>

<p><a href="classmagma__thread__queue-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a8509f1128d7315a848631020ed571779"></a><!-- doxytag: member="magma_thread_queue::magma_thread_queue" ref="a8509f1128d7315a848631020ed571779" args="()" -->
&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a8509f1128d7315a848631020ed571779">magma_thread_queue</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Creates queue with NO threads. Use <a class="el" href="classmagma__thread__queue.html#a357744e19d6baf75b014f7f692cbf0ea">launch</a> to create threads. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a85f9f3471cd59153184327d0ec015bd1"></a><!-- doxytag: member="magma_thread_queue::~magma_thread_queue" ref="a85f9f3471cd59153184327d0ec015bd1" args="()" -->
&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a85f9f3471cd59153184327d0ec015bd1">~magma_thread_queue</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Calls <a class="el" href="classmagma__thread__queue.html#a289689493610414cfa716dce2561e6cf">quit</a>, then deallocates data. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a357744e19d6baf75b014f7f692cbf0ea">launch</a> (magma_int_t in_nthread)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Creates threads.  <a href="#a357744e19d6baf75b014f7f692cbf0ea"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a9220f8ad5466f976dcc094f492474e93">push_task</a> (magma_task *task)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add task to queue.  <a href="#a9220f8ad5466f976dcc094f492474e93"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a131b04a3dadf057fa5c13a6395096c9e">sync</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Block until all outstanding tasks have been finished.  <a href="#a131b04a3dadf057fa5c13a6395096c9e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a289689493610414cfa716dce2561e6cf">quit</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sets quit_flag, so <a class="el" href="classmagma__thread__queue.html#a2819b023e5d04949f96d5f142eeec13d">pop_task</a> will return NULL once queue is empty, telling threads to exit.  <a href="#a289689493610414cfa716dce2561e6cf"></a><br/></td></tr>
<tr><td colspan="2"><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">magma_task *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a2819b023e5d04949f96d5f142eeec13d">pop_task</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get next task from queue.  <a href="#a2819b023e5d04949f96d5f142eeec13d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#ad9ee2c11aae7957647606d6ea06b0db6">task_done</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Marks task as finished, decrementing number of outstanding tasks.  <a href="#ad9ee2c11aae7957647606d6ea06b0db6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a65afbd1d75b551159d75e69dc0258b0f"></a><!-- doxytag: member="magma_thread_queue::get_thread_index" ref="a65afbd1d75b551159d75e69dc0258b0f" args="(pthread_t thread) const " -->
magma_int_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a65afbd1d75b551159d75e69dc0258b0f">get_thread_index</a> (pthread_t thread) const </td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Mostly for debugging, returns thread index in range 0, ..., nthread-1. <br/></td></tr>
<tr><td colspan="2"><h2>Friends</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classmagma__thread__queue.html#a67218e4b6080631da1d3b04dd2f44ab9">magma_thread_main</a> (void *arg)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Thread's main routine, executed by pthread_create.  <a href="#a67218e4b6080631da1d3b04dd2f44ab9"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Implements a thread pool with a multi-producer, multi-consumer queue. </p>
<p>Typical use: A main thread creates the queue and tells it to launch worker threads. Then the main thread inserts (pushes) tasks into the queue. Threads will execute the tasks. No dependencies are tracked. The main thread can sync the queue, waiting for all current tasks to finish, and then insert more tasks into the queue. When finished, the main thread calls quit or simply destructs the queue, which will exit all worker threads.</p>
<p>Tasks are sub-classes of magma_task. They must implement the run() function.</p>
<p>Example ------- </p>
<div class="fragment"><pre class="fragment">    <span class="keyword">class </span>task1: <span class="keyword">public</span> magma_task {
    <span class="keyword">public</span>:
        task1( <span class="keywordtype">int</span> arg ):
            m_arg( arg ) {}
        
        <span class="keyword">virtual</span> <span class="keywordtype">void</span> run() { do_task1( m_arg ); }
    <span class="keyword">private</span>:
        <span class="keywordtype">int</span> m_arg;
    };
    
    <span class="keyword">class </span>task2: <span class="keyword">public</span> magma_task {
    <span class="keyword">public</span>:
        task2( <span class="keywordtype">int</span> arg1, <span class="keywordtype">int</span> arg2 ):
            m_arg1( arg1 ), m_arg2( arg2 ) {}
        
        <span class="keyword">virtual</span> <span class="keywordtype">void</span> run() { do_task2( m_arg1, m_arg2 ); }
    <span class="keyword">private</span>:
        <span class="keywordtype">int</span> m_arg1, m_arg2;
    };
    
    <span class="keywordtype">void</span> master( <span class="keywordtype">int</span> n ) {
        <a class="code" href="classmagma__thread__queue.html" title="Implements a thread pool with a multi-producer, multi-consumer queue.">magma_thread_queue</a> queue;
        queue.<a class="code" href="classmagma__thread__queue.html#a357744e19d6baf75b014f7f692cbf0ea" title="Creates threads.">launch</a>( 12 );  <span class="comment">// 12 worker threads</span>
        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i &lt; n; ++i ) {
            queue.<a class="code" href="classmagma__thread__queue.html#a9220f8ad5466f976dcc094f492474e93" title="Add task to queue.">push_task</a>( <span class="keyword">new</span> task1( i ));
        }
        queue.<a class="code" href="classmagma__thread__queue.html#a131b04a3dadf057fa5c13a6395096c9e" title="Block until all outstanding tasks have been finished.">sync</a>();  <span class="comment">// wait for all task1 to finish before doing task2.</span>
        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i &lt; n; ++i ) {
            <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j=0; j &lt; i; ++j ) {
                queue.<a class="code" href="classmagma__thread__queue.html#a9220f8ad5466f976dcc094f492474e93" title="Add task to queue.">push_task</a>( <span class="keyword">new</span> task2( i, j ));
            }
        }
        queue.<a class="code" href="classmagma__thread__queue.html#a289689493610414cfa716dce2561e6cf" title="Sets quit_flag, so pop_task will return NULL once queue is empty, telling threads...">quit</a>();  <span class="comment">// [optional] explicitly exit worker threads</span>
    }
</pre></div><p>This is similar to python's queue class, but also implements worker threads and adds quit mechanism. sync is like python's join, but threads do not exit, so join would be a misleading name. </p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a357744e19d6baf75b014f7f692cbf0ea"></a><!-- doxytag: member="magma_thread_queue::launch" ref="a357744e19d6baf75b014f7f692cbf0ea" args="(magma_int_t in_nthread)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void magma_thread_queue::launch </td>
          <td>(</td>
          <td class="paramtype">magma_int_t&nbsp;</td>
          <td class="paramname"> <em>in_nthread</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Creates threads. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>in_nthread</em>&nbsp;</td><td>Number of threads to launch. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a2819b023e5d04949f96d5f142eeec13d"></a><!-- doxytag: member="magma_thread_queue::pop_task" ref="a2819b023e5d04949f96d5f142eeec13d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">magma_task * magma_thread_queue::pop_task </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get next task from queue. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>next task, blocking until a task is inserted if necesary. </dd>
<dd>
NULL if queue is empty *and* <a class="el" href="classmagma__thread__queue.html#a289689493610414cfa716dce2561e6cf">quit</a> has been called.</dd></dl>
<p>This does *not* decrement number of outstanding tasks; thread should call <a class="el" href="classmagma__thread__queue.html#ad9ee2c11aae7957647606d6ea06b0db6">task_done</a> when task is completed. </p>

</div>
</div>
<a class="anchor" id="a9220f8ad5466f976dcc094f492474e93"></a><!-- doxytag: member="magma_thread_queue::push_task" ref="a9220f8ad5466f976dcc094f492474e93" args="(magma_task *task)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void magma_thread_queue::push_task </td>
          <td>(</td>
          <td class="paramtype">magma_task *&nbsp;</td>
          <td class="paramname"> <em>task</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add task to queue. </p>
<p>Task must be allocated with C++ new. Increments number of outstanding tasks. Signals threads that are waiting in pop_task. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in]</tt>&nbsp;</td><td valign="top"><em>task</em>&nbsp;</td><td>Task to queue. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a289689493610414cfa716dce2561e6cf"></a><!-- doxytag: member="magma_thread_queue::quit" ref="a289689493610414cfa716dce2561e6cf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void magma_thread_queue::quit </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Sets quit_flag, so <a class="el" href="classmagma__thread__queue.html#a2819b023e5d04949f96d5f142eeec13d">pop_task</a> will return NULL once queue is empty, telling threads to exit. </p>
<p>Signals all threads that are waiting in pop_task. Waits for all threads to exit (i.e., joins them). It is safe to call quit multiple times -- the first time all the threads are joined; subsequent times it does nothing. (Destructor also calls quit, but you may prefer to call it explicitly.) </p>

</div>
</div>
<a class="anchor" id="a131b04a3dadf057fa5c13a6395096c9e"></a><!-- doxytag: member="magma_thread_queue::sync" ref="a131b04a3dadf057fa5c13a6395096c9e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void magma_thread_queue::sync </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Block until all outstanding tasks have been finished. </p>
<p>Threads continue to be alive; more tasks can be pushed after sync. </p>

</div>
</div>
<a class="anchor" id="ad9ee2c11aae7957647606d6ea06b0db6"></a><!-- doxytag: member="magma_thread_queue::task_done" ref="ad9ee2c11aae7957647606d6ea06b0db6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void magma_thread_queue::task_done </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Marks task as finished, decrementing number of outstanding tasks. </p>
<p>Signals threads that are waiting in <a class="el" href="classmagma__thread__queue.html#a131b04a3dadf057fa5c13a6395096c9e">sync</a>. </p>

</div>
</div>
<hr/><h2>Friends And Related Function Documentation</h2>
<a class="anchor" id="a67218e4b6080631da1d3b04dd2f44ab9"></a><!-- doxytag: member="magma_thread_queue::magma_thread_main" ref="a67218e4b6080631da1d3b04dd2f44ab9" args="(void *arg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void* magma_thread_main </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>arg</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [friend]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Thread's main routine, executed by pthread_create. </p>
<p>Executes tasks from queue (given as arg), until a NULL task is returned. Deletes each task when it is done. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"><tt>[in,out]</tt>&nbsp;</td><td valign="top"><em>arg</em>&nbsp;</td><td><a class="el" href="classmagma__thread__queue.html" title="Implements a thread pool with a multi-producer, multi-consumer queue.">magma_thread_queue</a> to get tasks from. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>/home/tomov/trunk/tools/magma-1.6.0/control/thread_queue.hpp</li>
<li>/home/tomov/trunk/tools/magma-1.6.0/control/thread_queue.cpp</li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 15 Nov 2014 for MAGMA by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
